{"version":3,"file":null,"sources":["../lib/index.js"],"sourcesContent":["import { Stream } from '@tempest/core';\nexport function flatten(stream) {\n    return new Stream(new Flatten(stream.source));\n}\nconst emptyDisposable = { dispose: () => { return void 0; } };\nexport class Flatten {\n    constructor(source) {\n        this.source = source;\n    }\n    run(sink, scheduler) {\n        const flattenSink = new FlattenSink(sink, scheduler);\n        const disposable = this.source.run(flattenSink, scheduler);\n        return {\n            dispose() {\n                flattenSink.dispose();\n                disposable.dispose();\n            }\n        };\n    }\n}\nclass FlattenSink {\n    constructor(sink, scheduler) {\n        this.sink = sink;\n        this.scheduler = scheduler;\n        this.current = null;\n        this.ended = false;\n    }\n    event(time, value) {\n        this._disposeCurrent(time);\n        this.current = new Segment(time, Infinity, this, this.sink);\n        this.current.disposable = value.source.run(this.current, this.scheduler);\n    }\n    error(time, err) {\n        this.ended = true;\n        this.sink.error(time, err);\n    }\n    end(time) {\n        this.ended = true;\n        this._checkEnd(time, void 0);\n    }\n    dispose() {\n        return this._disposeCurrent(0);\n    }\n    _disposeCurrent(time) {\n        if (this.current !== null) {\n            return this.current._dispose(time);\n        }\n    }\n    _disposeInner(time, inner) {\n        inner._dispose(time);\n        if (inner === this.current) {\n            this.current = null;\n        }\n    }\n    _checkEnd(time, value) {\n        if (this.ended && this.current === null) {\n            this.sink.end(time, value);\n        }\n    }\n    _endInner(time, value, inner) {\n        this._disposeInner(time, inner);\n        this._checkEnd(time, value);\n    }\n    _errorInner(time, err, inner) {\n        this._disposeInner(time, inner);\n        this.sink.error(time, err);\n    }\n}\nclass Segment {\n    constructor(min, max, outer, sink) {\n        this.min = min;\n        this.max = max;\n        this.outer = outer;\n        this.sink = sink;\n        this.disposable = emptyDisposable;\n    }\n    event(time, value) {\n        if (time < this.max) {\n            this.sink.event(Math.max(time, this.min), value);\n        }\n    }\n    error(time, err) {\n        this.outer._errorInner(Math.max(time, this.min), err, this);\n    }\n    end(time, value) {\n        this.outer._endInner(Math.max(time, this.min), value, this);\n    }\n    _dispose(time) {\n        this.max = time;\n        try {\n            this.disposable.dispose();\n        }\n        catch (e) {\n            this.sink.error(time, e);\n        }\n    }\n}\n//# sourceMappingURL=index.js.map"],"names":["Stream","const"],"mappings":";;;;;;IACO,SAAS,OAAO,CAAC,MAAM,EAAE;QAC5B,OAAO,IAAIA,oBAAM,CAAC,IAAI,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC;KACjD;AACDC,IAAAA,IAAM,eAAe,GAAG,EAAE,OAAO,EAAE,YAAG,EAAK,OAAO,KAAK,CAAC,CAAC,EAAE,EAAE,CAAC;AAC9D,AAAO,IAAA,IAAM,OAAO,GAAC,gBACN,CAAC,MAAM,EAAE;QACpB,IAAQ,CAAC,MAAM,GAAG,MAAM,CAAC;AAC7B,IAAA,CAAK,CAAA;AACL,IAAA,kBAAI,GAAG,iBAAC,IAAI,EAAE,SAAS,EAAE;QACrB,IAAU,WAAW,GAAG,IAAI,WAAW,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;QACzD,IAAU,UAAU,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,WAAW,EAAE,SAAS,CAAC,CAAC;QAC/D,OAAW;YACP,OAAW,kBAAA,GAAG;gBACV,WAAe,CAAC,OAAO,EAAE,CAAC;gBAC1B,UAAc,CAAC,OAAO,EAAE,CAAC;aACxB;SACJ,CAAC;AACV,IAAA,CAAK,CAAA;AAEL,IAAA,IAAM,WAAW,GAAC,oBACH,CAAC,IAAI,EAAE,SAAS,EAAE;QAC7B,IAAQ,CAAC,IAAI,GAAG,IAAI,CAAC;QACrB,IAAQ,CAAC,SAAS,GAAG,SAAS,CAAC;QAC/B,IAAQ,CAAC,OAAO,GAAG,IAAI,CAAC;QACxB,IAAQ,CAAC,KAAK,GAAG,KAAK,CAAC;AAC3B,IAAA,CAAK,CAAA;AACL,IAAA,sBAAI,KAAK,mBAAC,IAAI,EAAE,KAAK,EAAE;QACnB,IAAQ,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;QAC/B,IAAQ,CAAC,OAAO,GAAG,IAAI,OAAO,CAAC,IAAI,EAAE,QAAQ,EAAE,IAAI,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC;QAChE,IAAQ,CAAC,OAAO,CAAC,UAAU,GAAG,KAAK,CAAC,MAAM,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;AACjF,IAAA,CAAK,CAAA;AACL,IAAA,sBAAI,KAAK,mBAAC,IAAI,EAAE,GAAG,EAAE;QACjB,IAAQ,CAAC,KAAK,GAAG,IAAI,CAAC;QACtB,IAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE,GAAG,CAAC,CAAC;AACnC,IAAA,CAAK,CAAA;AACL,IAAA,sBAAI,GAAG,iBAAC,IAAI,EAAE;QACV,IAAQ,CAAC,KAAK,GAAG,IAAI,CAAC;QACtB,IAAQ,CAAC,SAAS,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC,CAAC;AACrC,IAAA,CAAK,CAAA;AACL,IAAA,sBAAI,OAAO,uBAAG;QACV,OAAW,IAAI,CAAC,eAAe,CAAC,CAAC,CAAC,CAAC;AACvC,IAAA,CAAK,CAAA;AACL,IAAA,sBAAI,eAAe,6BAAC,IAAI,EAAE;QACtB,IAAQ,IAAI,CAAC,OAAO,KAAK,IAAI,EAAE;YAC3B,OAAW,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;SACtC;AACT,IAAA,CAAK,CAAA;AACL,IAAA,sBAAI,aAAa,2BAAC,IAAI,EAAE,KAAK,EAAE;QAC3B,KAAS,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;QACzB,IAAQ,KAAK,KAAK,IAAI,CAAC,OAAO,EAAE;YAC5B,IAAQ,CAAC,OAAO,GAAG,IAAI,CAAC;SACvB;AACT,IAAA,CAAK,CAAA;AACL,IAAA,sBAAI,SAAS,uBAAC,IAAI,EAAE,KAAK,EAAE;QACvB,IAAQ,IAAI,CAAC,KAAK,IAAI,IAAI,CAAC,OAAO,KAAK,IAAI,EAAE;YACzC,IAAQ,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;SAC9B;AACT,IAAA,CAAK,CAAA;AACL,IAAA,sBAAI,SAAS,uBAAC,IAAI,EAAE,KAAK,EAAE,KAAK,EAAE;QAC9B,IAAQ,CAAC,aAAa,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;QACpC,IAAQ,CAAC,SAAS,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;AACpC,IAAA,CAAK,CAAA;AACL,IAAA,sBAAI,WAAW,yBAAC,IAAI,EAAE,GAAG,EAAE,KAAK,EAAE;QAC9B,IAAQ,CAAC,aAAa,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;QACpC,IAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE,GAAG,CAAC,CAAC;AACnC,IAAA,CAAK,CAAA;AAEL,IAAA,IAAM,OAAO,GAAC,gBACC,CAAC,GAAG,EAAE,GAAG,EAAE,KAAK,EAAE,IAAI,EAAE;QACnC,IAAQ,CAAC,GAAG,GAAG,GAAG,CAAC;QACnB,IAAQ,CAAC,GAAG,GAAG,GAAG,CAAC;QACnB,IAAQ,CAAC,KAAK,GAAG,KAAK,CAAC;QACvB,IAAQ,CAAC,IAAI,GAAG,IAAI,CAAC;QACrB,IAAQ,CAAC,UAAU,GAAG,eAAe,CAAC;AAC1C,IAAA,CAAK,CAAA;AACL,IAAA,kBAAI,KAAK,mBAAC,IAAI,EAAE,KAAK,EAAE;QACnB,IAAQ,IAAI,GAAG,IAAI,CAAC,GAAG,EAAE;YACrB,IAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE,IAAI,CAAC,GAAG,CAAC,EAAE,KAAK,CAAC,CAAC;SACpD;AACT,IAAA,CAAK,CAAA;AACL,IAAA,kBAAI,KAAK,mBAAC,IAAI,EAAE,GAAG,EAAE;QACjB,IAAQ,CAAC,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE,IAAI,CAAC,GAAG,CAAC,EAAE,GAAG,EAAE,IAAI,CAAC,CAAC;AACpE,IAAA,CAAK,CAAA;AACL,IAAA,kBAAI,GAAG,iBAAC,IAAI,EAAE,KAAK,EAAE;QACjB,IAAQ,CAAC,KAAK,CAAC,SAAS,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE,IAAI,CAAC,GAAG,CAAC,EAAE,KAAK,EAAE,IAAI,CAAC,CAAC;AACpE,IAAA,CAAK,CAAA;AACL,IAAA,kBAAI,QAAQ,sBAAC,IAAI,EAAE;QACf,IAAQ,CAAC,GAAG,GAAG,IAAI,CAAC;QACpB,IAAQ;YACJ,IAAQ,CAAC,UAAU,CAAC,OAAO,EAAE,CAAC;SAC7B;QACL,OAAW,CAAC,EAAE;YACV,IAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC;SAC5B;AACT,IAAA,CAAK,CAAA;;;;;;;"}