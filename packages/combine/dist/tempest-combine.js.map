{"version":3,"file":null,"sources":["../lib/index.js"],"sourcesContent":["import { Stream, IndexSink } from '@tempest/core';\nexport const combine = function (streams) {\n    return new Stream(new Combine(streams.map(getSource)));\n};\nfunction getSource(stream) {\n    return stream.source;\n}\nexport class Combine {\n    constructor(sources) {\n        this.sources = sources;\n    }\n    run(sink, scheduler) {\n        const length = this.sources.length;\n        const disposables = new Array(length);\n        const sinks = new Array(length);\n        const mergeSink = new CombineSink(disposables, sinks, sink);\n        let indexSink;\n        for (let i = 0; i < length; ++i) {\n            indexSink = sinks[i] = new IndexSink(i, mergeSink);\n            disposables[i] = this.sources[i].run(indexSink, scheduler);\n        }\n        return {\n            dispose() {\n                disposables.forEach((disposable) => {\n                    disposable.dispose();\n                });\n            }\n        };\n    }\n}\nclass CombineSink {\n    constructor(disposables, sinks, sink) {\n        this.disposables = disposables;\n        this.sinks = sinks;\n        this.sink = sink;\n        const l = sinks.length;\n        this.awaiting = l;\n        this.values = new Array(l);\n        this.hasValue = new Array(l);\n        for (let i = 0; i < l; ++i) {\n            this.hasValue[i] = false;\n        }\n        this.activeCount = l;\n    }\n    event(time, value) {\n        const i = value.index;\n        const awaiting = this._updateReady(i);\n        this.values[i] = value.value;\n        if (awaiting === 0) {\n            this.sink.event(time, this.values);\n        }\n    }\n    error(time, err) {\n        this.sink.error(time, err);\n    }\n    end(time, value) {\n        tryDispose(time, this.disposables[value.index], this.sink);\n        if (--this.activeCount === 0) {\n            this.sink.end(time, this.values);\n        }\n    }\n    _updateReady(i) {\n        if (this.awaiting > 0) {\n            if (!this.hasValue[i]) {\n                this.hasValue[i] = true;\n                this.awaiting -= 1;\n            }\n        }\n        return this.awaiting;\n    }\n}\nfunction tryDispose(time, disposable, sink) {\n    try {\n        disposable.dispose();\n    }\n    catch (e) {\n        sink.error(time, e);\n    }\n}\n//# sourceMappingURL=index.js.map"],"names":["const","Stream","let","IndexSink","this"],"mappings":"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"}