{"version":3,"file":null,"sources":["../lib/index.js"],"sourcesContent":["import { Stream } from '@tempest/core';\nexport const replaceError = function (f, stream) {\n    switch (arguments.length) {\n        case 1: return function (stream) { return new Stream(new ReplaceError(f, stream.source)); };\n        case 2: return new Stream(new ReplaceError(f, stream.source));\n        default: return replaceError;\n    }\n};\nexport class ReplaceError {\n    constructor(f, source) {\n        this.f = f;\n        this.source = source;\n    }\n    run(sink, scheduler) {\n        return new ReplaceErrorSink(this.f, this.source, sink, scheduler);\n    }\n}\nclass ReplaceErrorSink {\n    constructor(f, source, sink, scheduler) {\n        this.f = f;\n        this.scheduler = scheduler;\n        this.sink = new SafeSink(sink);\n        this.disposable = source.run(this, scheduler);\n    }\n    event(time, value) {\n        try {\n            this.sink.event(time, value);\n        }\n        catch (e) {\n            this.sink.error(time, e);\n        }\n    }\n    error(time, err) {\n        const nextSink = this.sink.disable();\n        tryDispose(this.disposable, this.sink);\n        this._startNext(time, err, nextSink);\n    }\n    end(time, value) {\n        try {\n            this.sink.end(time, value);\n        }\n        catch (e) {\n            this.sink.error(time, e);\n        }\n    }\n    _startNext(time, err, sink) {\n        try {\n            this.disposable = this._continue(this.f, err, sink);\n        }\n        catch (e) {\n            sink.error(time, e);\n        }\n    }\n    _continue(f, err, sink) {\n        const stream = f(err);\n        return stream.source.run(sink, this.scheduler);\n    }\n    dispose() {\n        this.disposable.dispose();\n    }\n}\nclass SafeSink {\n    constructor(sink) {\n        this.sink = sink;\n        this.active = true;\n    }\n    event(t, x) {\n        if (!this.active)\n            return;\n        this.sink.event(t, x);\n    }\n    error(t, err) {\n        this.disable();\n        this.sink.error(t, err);\n    }\n    end(t, x) {\n        if (!this.active)\n            return;\n        this.disable();\n        this.sink.end(t, x);\n    }\n    disable() {\n        this.active = false;\n        return this.sink;\n    }\n}\nfunction tryDispose(disposable, sink) {\n    try {\n        disposable.dispose();\n    }\n    catch (e) {\n        sink.error(Date.now(), e);\n    }\n}\n//# sourceMappingURL=index.js.map"],"names":["const","Stream"],"mappings":"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"}